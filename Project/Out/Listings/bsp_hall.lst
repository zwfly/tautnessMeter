C51 COMPILER V9.56.0.0   BSP_HALL                                                          08/22/2017 22:57:44 PAGE 1   


C51 COMPILER V9.56.0.0, COMPILATION OF MODULE BSP_HALL
OBJECT MODULE PLACED IN .\Out\Objects\bsp_hall.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\Bsp\src\bsp_hall.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Common\in
                    -c;..\App\inc;..\Bsp\inc;..\Startup;..\Bsp) DEFINE(FOSC_110592) DEBUG OBJECTEXTEND PRINT(.\Out\Listings\bsp_hall.lst) OBJ
                    -ECT(.\Out\Objects\bsp_hall.obj)

line level    source

   1          /*
   2           * bsp_hall.c
   3           *
   4           *  Created on: 2017年6月26日
   5           *      Author: fly
   6           */
   7          
   8          #include "bsp.h"
   9          #include "app_work.h"
  10          #include "bsp_beep.h"
  11          
  12          #define HALL_NUM  3
  13          #define HALL_CNT_UP  100
  14          #define HALL_CNT_DOWN  10
  15          
  16          static HALL_T g_tHall;
  17          
  18          static void Hall_InitHard(void) {
  19   1      
  20   1              P5M1 &= ~ SET_BIT4;
  21   1              P5M2 |= SET_BIT4;
  22   1      
  23   1              bsp_hallInt_open();
  24   1      
  25   1              set_EPI;
  26   1      }
  27          static void Hall_InitVar(void) {
  28   1              g_tHall.count = 0;
  29   1              g_tHall.direction = 0;
  30   1              g_tHall.lastPos = 0;
  31   1      
  32   1      }
  33          
  34          void bsp_hallInt_open(void) {
  35   1      
  36   1              P54 = 0;
  37   1      
  38   1              set_PIPS2;
  39   1              clr_PIPS1;
  40   1              set_PIPS0;
  41   1      
  42   1              set_PIT1;
  43   1              set_PIT2;
  44   1              set_PIT3;
  45   1      
  46   1              set_PINEN1;
  47   1              set_PINEN2;
  48   1              set_PINEN3;
  49   1      
  50   1              clr_PIPEN1;
  51   1              clr_PIPEN2;
  52   1              clr_PIPEN3;
  53   1      
C51 COMPILER V9.56.0.0   BSP_HALL                                                          08/22/2017 22:57:44 PAGE 2   

  54   1      }
  55          void bsp_hallInt_close(void) {
  56   1      
  57   1              P54 = 1;
  58   1      
  59   1              clr_PIT1;
  60   1              clr_PIT2;
  61   1              clr_PIT3;
  62   1      
  63   1              clr_PINEN1;
  64   1              clr_PINEN2;
  65   1              clr_PINEN3;
  66   1      }
  67          void Hall_Init(void) {
  68   1              Hall_InitHard();
  69   1              Hall_InitVar();
  70   1      }
  71          
  72          void hall_pro(uint8_t n) {
  73   1              static BIT valid_flag = 0;
  74   1      
  75   1              BEEP_Start(0, 5, 1, 1);
  76   1      
  77   1              if (((n - g_tHall.lastPos) == 1) || ((g_tHall.lastPos - n) == 2)) {
  78   2                      g_tHall.direction = 1;  //拉长方向
  79   2                      if (g_tHall.count < 255) {
  80   3                              g_tHall.count++;
  81   3                      }
  82   2      
  83   2              } else {
  84   2                      g_tHall.direction = 0;  //收缩方向
  85   2                      if (g_tHall.count) {
  86   3                              g_tHall.count--;
  87   3                      }
  88   2              }
  89   1              g_tHall.lastPos = n;
  90   1      
  91   1              if (valid_flag) {
  92   2                      if (g_tHall.count < HALL_CNT_DOWN) {
  93   3                              valid_flag = 0;
  94   3                      }
  95   2              } else {
  96   2                      if (g_tHall.count > HALL_CNT_UP) {
  97   3                              valid_flag = 1;
  98   3                              /* your code   --start */
  99   3                              // 拉一次计数一次，计数一次调用一次
 100   3                              query_work_sum();
 101   3                              /* your code   --end */
 102   3                      }
 103   2              }
 104   1      
 105   1      }
 106          
 107          void hall_1_interrupt(void) {
 108   1              hall_pro(1);
 109   1      }
 110          void hall_2_interrupt(void) {
 111   1              hall_pro(2);
 112   1      }
 113          void hall_3_interrupt(void) {
 114   1              hall_pro(3);
 115   1      }
C51 COMPILER V9.56.0.0   BSP_HALL                                                          08/22/2017 22:57:44 PAGE 3   



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    224    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      3       1
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
